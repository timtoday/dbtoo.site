---
title: FreeBSD6.2架设WEB服务器备忘-手动
tags:
- FreeBSD
- FAMP
- LAMP
---
<div> <p>安装mysql5</p><p>cd /usr/ports/databases/mysql51-server<br>#编译安装（FreeBSD默认不带入所有字符集支持，需要声明打开）<br>make WITH_XCHARSET=all install clean<br>或自定义参数：<br>#make WITH_CHARSET=gbk WITH_XCHARSET=all WITH_PROC_SCOPE_PTH=yes BUILD_OPTIMIZED=yes BUILD_STATIC=yes SKIP_DNS_CHECK=yes WITHOUT_INNODB=yes install clean</p><p>rehash</p><p>#复制配置文件（#服务器内存1G，但是与apache在一起）：<br>cp /usr/local/share/mysql/my-large.cnf /etc/my.cnf</p><p>#设置随机启动：<br>vi /etc/rc.conf<br>mysql_enable="YES"</p><p>#初始化：<br>/usr/local/bin/mysql_install_db --user=mysql <br>#更改数据库权限（若所有者不是mysql）：<br>chown -R mysql /var/db/mysql/</p><p>#立即启动：<br>/usr/local/bin/mysqld_safe -user=mysql &amp;</p><p>#修改mysql root密码：<br>/usr/local/bin/mysqladmin -u root password 'newpasswd'</p><p>1、创建mysql用户和mysql用户组，并修改目录权限<br>#pw groupadd mysql -g 88<br>#pw adduser mysql -u 88 -g 88 -d /nonexistent -s /sbin/nologin<br>#chown -R mysql:mysql /var/db/mysql<br>#chown -R mysql:mysql /usr/local/share/mysql<br>2、创建mysql系统数据库<br>#/usr/local/bin/mysql_install_db<br>#/usr/lcoal/bin/mysql_create_system_tables<br>3、创建mysql自启动脚本<br>#cp /usr/local/share/mysql/mysql.server /usr/local/etc/rc.d/mysql-server.sh<br>4、创建mysql配置文件 my.cnf<br>#cp /usr/local/share/mysql/my-medium.cnf /etc/my.cnf (有my-medium、small、large、huge等可选）</p><p> </p><p>#测试：<br>mysql -u root -p<br>mysql&gt; show databases;</p><p><br>#启动/重启/停止mysqld<br>/usr/local/etc/rc.d/mysql-server start (等于/usr/local/bin/mysqld_safe -user=mysql &amp;)<br>/usr/local/etc/rc.d/mysql-server restart<br>/usr/local/etc/rc.d/mysql-server stop</p><p># end</p><p> </p><p><br>安装 apache 2.0.59</p><p>#先确定网路通畅<br>ping <a href="http://www.apache.org/">www.apache.org</a><br>ping </p><p>cd /usr/ports/www/apache20</p><p>#确定版本：<br>less distinfo<br>#MD5 (apache2/httpd-2.0.59.tar.bz2) = b0200a497d1c89daad680c676d32a6df</p><p>#会用到这些库，安装过程会自动下载所需要的库<br>perl-5.8.8<br>autoconf-2.59_2<br>libtool-1.5.22_4<br>expat-2.0.0_1<br>libiconv-1.9.2_2<br>m4-1.4.8_1<br>help2man-1.36.4_1<br>gmake-3.81_1<br>p5-gettext-1.05_1<br>gettext-0.16.1<br>apache-2.0.59</p><p>#开始安装<br>make install clean;rehash</p><p># download and waiting...<br>===&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Vulnerability check disabled, database not found<br>=&gt; httpd-2.0.59.tar.bz2 doesn't seem to exist in /usr/ports/distfiles/apache2.<br>=&gt; Attempting to fetch from <a href="http://www.apache.org/dist/httpd/">http://www.apache.org/dist/httpd/</a>.<br>httpd-2.0.59.tar.bz2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0% of 4632 kB 1394&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Bps</p><p>#若fetch的速度太慢，ctrl+c暂停安装，另用工具下载文件并上传到/usr/ports/distfiles/ 中然后make install clean;rehash可以继续安装<br>#（按装需要用到的源码包都会存放在这里，可打包备份以便以后用到）</p><p>#完毕，留意一下安装信息</p><p>#检查是否安装成功<br>pkg_info</p><p>#修改配置<br>vi /usr/local/etc/apache2/httpd.conf</p><p>#立即启动<br>/usr/local/etc/rc.d/apache2.sh startup</p><p>#查看有没监控80端口<br>netstat -an</p><p>#控制：启动/重启/停止<br>/usr/local/etc/rc.d/apache2.sh startup<br>/usr/local/etc/rc.d/apache2 restart<br>/usr/local/etc/rc.d/apache2 stop</p><p>#To run apache www server from startup, add apache2_enable="YES"<br>#以后随机自动启动<br>vi /etc/rc.conf<br>#添加<br>apache2_enable="YES"</p><p>#The End</p><p> </p><p>安装php 5.2.1</p><p>#热身阅读：<br>#http://bbs.chinaunix.net/viewthread.php?tid=848816<br>#http://netflow.kmseh.gov.tw/blog/index.php?op=ViewArticle&amp;articleId=13&amp;blogId=1<br>#http://www.phoebus.cn/?action=show&amp;id=106<br>#http://tw.myblog.yahoo.com/bbsfans-blog/article?mid=19&amp;prev=-1&amp;next=12 <br>#php 5.2.1，<a href="http://br.php.net/distributions/php-5.2.1.tar.bz2">http://br.php.net/distributions/php-5.2.1.tar.bz2</a><br>#可预先下载放到/usr/ports/distfiles/中<br>#这里也有：<br>#http://www.freshports.org/lang/php5/</p><p>#进入ports目录：<br>cd /usr/ports/lang/php5</p><p>#检查版本：<br>cat distinfo<br>#MD5 (php-5.2.1.tar.bz2) = 261218e3569a777dbd87c16a15f05c8d</p><p>#安装<br>make install clean;rehash</p><p># 出现选择菜单： Options for php5 5.2.1_3 <br>#选择安装选项：<br>#选中：CLI,CGI,APACHE,SUHOSIN,MULTIBYTE,IPV6,FASTCGI,PATHINFO<br>#不要选DEGUG 否则Zend装不上<br>#SUHOSIN的简单说明：<a href="http://linux.chinaunix.net/bbs/thread-886577-1-9.html">http://linux.chinaunix.net/bbs/thread-886577-1-9.html</a></p><p>#完毕,3种模式的程序:<br>/usr/local/libexec/apache22/libphp5.so<br>/usr/local/bin/php<br>/usr/local/bin/php-cgi</p><p>#查看pkg:<br>pkg_info</p><p><br>#安装扩展：<br>cd /usr/ports/lang/php5-extensions<br>#编译安装:<br>make install clean;rehash<br>#选择扩展：<br>#选中(除默认之外)：<br>[X] CURL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  CURL support<br>[X] GD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  GD library support<br>[X] MBSTRING&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  multibyte string support<br>[X] GETTEXT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  gettext library support<br>[X] MYSQL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MySQL database support<br>[X] MYSQLI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MySQLi database support<br>[X] PCRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Perl Compatible Regular Expression support<br>[X] SOCKETS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  sockets support<br>[X] ZLIB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ZLIB support</p><p><br>#查看已安装包信息:<br>pkg_info</p><p>#配置php：<br>cd /usr/local/etc<br>cp php.ini-recommended php.ini</p><p><br>#调整apache(2.2.4)设置:<br>vi /usr/local/etc/apache22/Includes/php5.conf<br>#修改内容：<br>AddType application/x-httpd-php .php<br>AddType application/x-httpd-php-source .phps<br>DirectoryIndex index.php</p><p>#测试apache配置：<br>/usr/local/etc/rc.d/apache22 configtest<br>#OK就重读设置：<br>/usr/local/etc/rc.d/apache22 graceful</p><p>#建立测试页面：<br>vi /usr/local/www/vhosts/default/htdocs/test.php<br>#修改内容：<br>&lt;?php<br>phpinfo();</p><p>#访问：<br><a href="http://hostname/test.php">http://hostname/test.php</a></p><p>#The End</p><p> </p><p><br>mysql5 字符集问题</p><p>这篇是目前我所能找到最详细的了：<br><a href="http://www.discuz.net/viewthread.php?action=printable&amp;tid=201826">http://www.discuz.net/viewthread.php?action=printable&amp;tid=201826</a></p><p>在freebsd中的<br><a href="http://www.freebsdchina.org/forum/viewtopic.php?p=179463">http://www.freebsdchina.org/forum/viewtopic.php?p=179463</a></p><p><a href="http://blog.chinaunix.net/u/25477/showart_248080.html">http://blog.chinaunix.net/u/25477/showart_248080.html</a></p><p>结论：<br>1.若新数据库服务(msql4.1+)的默认字符集是latin1的，直接复制旧数据库来使用没有问题，但不能用2.6+版的phpmyadmin来管理。</p><p>freebsd6.2中，用ports默认安装的mysql5不支持GBx系列的字符集，需要重新编译使mysql5支持所有字符集合：<br>cd /usr/ports/databases/mysql51-server<br>#先停止服务<br>/usr/local/etc/rc.d/mysql-server stop<br>#卸载已安装的版本（不会伤害已有数据，过程很快，似乎只是删除一些管理脚本）<br>make deinstall<br>#加上包含进所有字符集（过程较久，还好是重编译，不用再去fetch源码包）<br>make WITH_XCHARSET=all install clean;rehash<br>#重新启动服务<br>/usr/local/etc/rc.d/mysql-server start</p><p><br>其他：<br>查看MYSQL支持的字符集：<br>SHOW CHARACTER SET<br>#=SELECT * FROM INFORMATION_SCHEMA.CHARACTER_SETS</p><p>SHOW VARIABLES LIKE 'character_set_%';</p><p>gbk的Collation=gbk_chinese_ci</p><p> </p><p>mysql的数据库路径</p><p>mysql默认的数据目录放在：/var/db/mysql，由于/var分区分的过小，空间满了，需要把数据库转到另一个分区上。</p><p># 默认root也无修改权限，先加上：<br>chmod +w /usr/local/etc/rc.d/mysql-server</p><p># 修改数据库路径：<br>vi /usr/local/etc/rc.d/mysql-server<br># 找到这行来修改：<br>: ${mysql_dbdir="/var/db/mysql"}</p><p># The End</p><p>apache 2.0.x 升级</p><p><br>#停止httpd:<br>/usr/local/etc/rc.d/apache2 stop</p><p>#卸载2.0.x，安装文件（源码包）还会保留在/usr/ports/distfiles中，需要可以重新编译安装，很方便：<br>cd /var/db/pkg/<br>pkg_delete apache-2.0.x<br>rehash</p><p>#安装新版：<br>cd /usr/ports/www/apache22<br>#重复以前的安装步骤</p><p>#The End</p><p> </p><p>合理设置apache httpd的最大连接数</p><p>手头有一个网站在线人数增多，访问时很慢。初步认为是服务器资源不足了，但经反复测试，一旦连接上，不断点击同 一个页面上不同的链接，都能迅速打开，这种现象就是说明apache最大连接数已经满了，新的访客只能排队等待有空闲的链接，而如果一旦连接上，在 keeyalive 的存活时间内（KeepAliveTimeout，默认5秒）都不用重新打开连接，因此解决的方法就是加大apache的最大连接数。</p><p>1.在哪里设置？</p><p>服务器的为FreeBSD 6.2 ，apache 2.24，使用默认配置（FreeBSD 默认不加载自定义MPM配置），默认最大连接数是250</p><p>在/usr/local/etc/apache22/httpd.conf中加载MPM配置（去掉前面的注释）：<br># Server-pool management (MPM specific)<br>Include etc/apache22/extra/httpd-mpm.conf</p><p>可见的MPM配置在/usr/local/etc/apache22/extra/httpd-mpm.conf，但里面根据httpd的工作模式分了很多块，哪一部才是当前httpd的工作模式呢？可通过执行 apachectl -l 来查看：<br>Compiled in modules:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  core.c<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  prefork.c<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  http_core.c<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  mod_so.c</p><p>看到prefork 字眼，因此可见当前httpd应该是工作在prefork模式，prefork模式的默认配置是：<br>&lt;IfModule mpm_prefork_module&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  StartServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MinSpareServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxSpareServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  10<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxClients&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  150<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxRequestsPerChild&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0<br>&lt;/IfModule&gt;</p><p>2.要加到多少？</p><p>连接数理论上当然是支持越大越好，但要在服务器的能力范围内，这跟服务器的CPU、内存、带宽等都有关系。</p><p>查看当前的连接数可以用：<br>ps aux | grep httpd | wc -l</p><p>或：<br>pgrep httpd|wc -l</p><p>计算httpd占用内存的平均数:<br>ps aux|grep -v grep|awk '/httpd/{sum+=$6;n++};END{print sum/n}'</p><p>由于基本都是静态页面，CPU消耗很低，每进程占用内存也不算多，大约200K。</p><p>服务器内存有2G，除去常规启动的服务大约需要500M（保守估计），还剩1.5G可用，那么理论上可以支持1.5*1024*1024*1024/200000 = 8053.06368</p><p>约8K个进程，支持2W人同时访问应该是没有问题的（能保证其中8K的人访问很快，其他的可能需要等待1、2秒才能连上，而一旦连上就会很流畅）</p><p>控制最大连接数的MaxClients ，因此可以尝试配置为：<br>&lt;IfModule mpm_prefork_module&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  StartServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MinSpareServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxSpareServers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  10<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  ServerLimit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5500<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxClients&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  5000<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  MaxRequestsPerChild&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0<br>&lt;/IfModule&gt;</p><p>注意，MaxClients默认最大为250，若要超过这个值就要显示设置ServerLimit，且ServerLimit要放在MaxClients之前，值要不小于MaxClients，不然重启httpd时会有提示。</p><p>重启httpd后，通过反复执行pgrep httpd|wc -l 来观察连接数，可以看到连接数在达到MaxClients的设值后不再增加，但此时访问网站也很流畅，那就不用贪心再设置更高的值了，不然以后如果网站访 问突增不小心就会耗光服务器内存，可根据以后访问压力趋势及内存的占用变化再逐渐调整，直到找到一个最优的设置值</p> </div>