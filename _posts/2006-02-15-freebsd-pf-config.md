---
title: freebsd 下pf详细配置
layout: post
tags:
- FreeBSD
- Firewall
- Kernel
---
<div> <p>要在 FreeBSD 6.2 上使用 PF 防火墙，有二个方式，一个是编译进入核心，另外是以动态模块方式加载。</p><p>编译进入核心的方式<br>#FreeBSD log traffic，如果有使用 pflog，就要编译进核心<br>device bpf<br>#启动 PF Firewall<br>device pf<br>#启动虚拟网络设备来记录流量(经由 bpf)<br>device pflog<br>#启动虚拟网络设备来监视网络状态<br>device pfsync</p><p>以动态模块加载<br>vi /etc/rc.conf<br>加入下面四行<br>#启用 PF<br>pf_enable="YES"<br>#PF 防火墙规则的设定文件<br>pf_rules="/etc/pf.conf"<br>#启用 inetd 服务<br>inetd_enable="YES"<br>#启动 pflogd<br>pflog_enable="YES"<br>#pflogd 储存记录档案的地方<br>pflog_logfile="/var/log/pflog"<br>#转送封包<br>gateway_enable="YES"</p><p>#开启 ftp-proxy 功能<br>vi /etc/inetd.conf<br>把下面这一行最前面的 # 删除<br>ftp-proxy stream tcp nowait root /usr/libexec/ftp-proxy ftp-proxy</p><p>使用 sysctl 做设定(也可以重新开机让设定生效)<br>sysctl -w net.inet.ip.forwarding=1</p><p>vi /etc/pf.conf<br>#对外的网络卡<br>ext_if = "sis0"<br>#对内的网络卡<br>int_if = "rl0"</p><p>#频宽控管<br>#定义 std_out 总频宽 512Kb<br>#altq on $ext_if cbq bandwidth 512Kb queue { std_out }<br>#定义 std_out 队列频宽 256Kb，使用预设队列<br>#queue std_out bandwith 256Kb cbq (default)<br>#定义 std_in 总频宽 2Mb<br>#altq on $int_if cbq bandwidth 2Mb queue { std_in }<br>#假设频宽足够的话，可以从父队列借用额外的频宽<br>#queue std_in bandwidth 768Kb cbq (brrrow)</p><p>#对外开放的服务<br>open_services = "{80, 443}"<br>#内部私有的 IP<br>priv_nets = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }"</p><p># options<br>#设定拒绝联机封包的处理方式<br>set block-policy return<br>#<br>set optimization aggressive<br>#纪录 $ext_if<br>set loginterface $ext_if</p><p># scrub<br>#整理封包<br>scrub in all</p><p>#nat<br>#NAT 地址转译处理<br>nat on $ext_if from $int_if:network to any -&gt; $ext_if</p><p>#ftp-proxy<br>#ftp-proxy 重新导向<br>rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021<br>#rdr on $ext_if proto tcp from any to 140.111.152.13 port 21 -&gt; 192.168.13.253 port 21<br>#Transparent Proxy Server<br>rdr on rl0 proto tcp from 192.168.13.0/24 to any 80 -&gt; 127.0.0.1 port 3128</p><p>#阻挡可疑封包在 $ext_if 网卡进出<br>antispoof log quick for $ext_if</p><p>#阻挡所有进出的封包<br>block all</p><p>#开放 loopback<br>pass quick on lo0 all</p><p>#拒绝内部私有 IP 对 $ext_if 网络卡联机<br>block drop in quick on $ext_if from $priv_nets to any<br>block drop out quick on $ext_if from any to $priv_nets</p><p>#开放对外的 80, 443 埠<br>pass in on $ext_if inet proto tcp from any to $ext_if port $open_services flags S/SA keep state<br>#只容许 140.111.152.0/24 网段对本机做 22 埠联机<br>pass in on $ext_if inet proto tcp from 140.111.152.0/24 to $ext_if port 22 flags S/SA keep state</p><p>#开放内部网络对外联机<br>#pass in on $inf_if proto rcp from any to any queue std_in<br>pass in on $int_if from $int_if:network to any keep state<br>pass out on $int_if from any to $int_if:network keep state</p><p>#开放对外网络的联机<br>#pass out $ext_if proto tcp from any to any queue std_out<br>pass out on $ext_if proto tcp all modulate state flags S/SA<br>pass out on $ext_if proto { udp, icmp } all keep state</p><p>启动 PF，并读取 pf 规则<br>pfctl -e;pfctl -f /etc/pf.conf</p><p>PF 指令的用法<br>#启动 PF<br>pfctl -e<br>#加载 PF 规则<br>pfctl -f /etc/pf.conf<br>#检查 PF 语法是否正确 (未加载)<br>pfctl -nf /etc/pf.conf<br>#停用 PF<br>pfctl -d<br>#重读 PF 设定档中的 NAT 部分<br>pfctl -f /etc/pf.conf -N<br>#重读 PF 设定档中的 filter rules<br>pfctl -f /etc/pf.conf -R<br>#重读 PF 设定文件中的选项规则<br>pfctl -f /etc/pf.conf -O</p><p>#查看 PF 信息<br>#显示现阶段过滤封包的统计资料<br>pfctl -s info<br>pfctl -si</p><p>pfctl -s memory</p><p>#显示现阶段过滤的规则<br>pfctl -s rules<br>pfctl -sr</p><p>pfctl -vs rules</p><p>#显示现阶段过滤封包的统计资料<br>pfctl -vsr</p><p>#显示现阶段 NAT 的规则<br>pfctl -s nat<br>pfctl -sn</p><p>#检视目前队列<br>pfctl -s queue</p><p>#显示现阶段所有统计的数据<br>pfctl -s all<br>pfctl -sa</p><p>#清除 PF 规则<br>#清空 NAT 规则<br>pfctl -F nat<br>#清空队列<br>pfctl -F queue<br>#清空封包过滤规则<br>pfctl -F rules<br>#清空计数器<br>pfctl -F info<br>pfctl -F Tables<br>#清空所有的规则<br>pfctl -F all</p><p>#PF Tables 的使用<br>#显示 table 内数据<br>pfctl -t ssh-bruteforce -Tshow<br>pfctl -t table_name -T add spammers.org<br>pfctl -t table_name -T delete spammers.org<br>pfctl -t table_name -T flush<br>pfctl -t table_name -T show<br>pfctl -t table_name -T zero</p><p>过滤扫描侦测软件<br>block in quick proto tcp all flags SF/SFRA<br>block in quick proto tcp all flags SFUP/SFRAU<br>block in quick proto tcp all flags FPU/SFRAUP<br>block in quick proto tcp all flags /SFRA<br>block in quick proto tcp all flags F/SFRA<br>block in quick proto tcp all flags U/SFRAU<br>block in quick proto tcp all flags P</p><p>如果防火墙和 Proxy Server 不在同一台主机<br>Proxy Server：192.168.13.250<br>no rdr on rl0 proto tcp from 192.168.13.250 to any port 80<br>rdr on rl0 proto tcp from 192.168.13.0/24 to any port 80 -&gt; 192.168.13.250 port 3128</p> </div>