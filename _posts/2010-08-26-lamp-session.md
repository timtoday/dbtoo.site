---
title:lamp 多服务器分布 session解决方案
layout: post
tags:
- Linux
- Lamp
---
<div> 一般大的门户网站肯定不只使用一台服务器，多台服务器怎么实现用户统一登录呢?<br/>有3种方法:<br/><br/>1.不用session 只使用cookies来保存用户验证状态 。<br/>2.session 存储在数据库里,根据session_id来获取信息。<br/>3.Memcached.<br/><br/><br/>第一种方法显然不安全，第2种方法是可行的，但是在较大流量使用网站时，数据库的负载肯定会很大。<br/>我这里要说的是第3种方法，个人觉得安全性能都比较优。<br/><br/><br/>1.首先安装Memcached 服务端可以到官方网站下载：<a href="http://www.danga.com/memcached/" target="_blank">http://www.danga.com/memcached/</a><br/><br/>2.安装php 的Memcached扩展<br/>      可以用 pecl 命令行工具安装：<br/>      pecl install memcache<br/><br/>3.改配置文件，在 php.ini 中全局设置：session.save_handler = memcache<br/>session.save_path = "tcp://127.0.0.1:11211"或者某个目录下的 .htaccess ：php_value session.save_handler "memcache"<br/>php_value session.save_path  "tcp://127.0.0.1:11211"再或者在某个一个应用中：ini_set("session.save_handler", "memcache");<br/>ini_set("session.save_path", "tcp://127.0.0.1:11211");<p>使用多个 memcached server 时用逗号","隔开，并且和 <a href="http://cn.php.net/manual/en/function.Memcache-addServer.php" target="_blank">Memcache::addServer()</a> 文档中说明的一样，可以带额外的参数"persistent"、"weight"、"timeout"、"retry_interval" 等等，类似这样的："tcp://host1:port1?persistent=1&amp;weight=2,tcp://host2:port2" 。</p><p>4. 启动 memcached：</p>memcached -d -l 127.0.0.1 -p 11212 -m 128<p>5. 在程序中使用 memcache 来作 session 存储，用例子测试一下：</p>&lt;?php<br/>session_start();<br/>if (!isset($_SESSION['TEST']))<br/>{<br/>    $_SESSION['TEST'] = time();<br/>}<br/><br/>$_SESSION['TEST3'] = time();<br/><br/>print $_SESSION['TEST'];<br/>print "&lt;br&gt;&lt;br&gt;";<br/>print $_SESSION['TEST3'];<br/>print "&lt;br&gt;&lt;br&gt;";<br/>print session_id();<br/>?&gt;<p>6. 用 sessionid 去 memcached 里查询一下：</p><br/>&lt;?php<br/>$memcache = memcache_connect('localhost', 11211);<br/>var_dump($memcache-&gt;get('19216821213c65cedec65b0883238c278eeb573e077'));<br/>?&gt;会有看到 string(37) "TEST|i:1177556731;TEST3|i:1177556881;"<p>这样的输出，证明 session 正常工作。</p><p>用 memcache 来存储 session 在读写速度上会比 files 时快很多，而且在多个服务器需要共用 session 时会比较方便，将这些服务器都配置成使用同一组 memcached 服务器就可以，减少了额外的工作量。缺点是 session 数据都保存在 memory 中，持久化方面有所欠缺，但对 session 数据来说也不是很大的问题。</p><p> </p><p>更多的关于Memcache的使用见<a href="http://docs.php.net/manual/zh/book.memcached.php" target="_blank">http://docs.php.net/manual/zh/book.memcached.php</a></p><p> </p> <br/> </div>